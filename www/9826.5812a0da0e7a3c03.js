"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[9826],{9826:(T,h,r)=>{r.r(h),r.d(h,{SensorPageModule:()=>O});var b=r(9808),v=r(4182),a=r(5056),l=r(2292),g=r(655),f=r(2198),t=r(2096),k=r(1414),c=r(4811),A=r(7011);const p="6e400001-b5a3-f393-e0a9-e50e24dc4179",w="6e400002-b5a3-f393-e0a9-e50e24dc4179",P="110434343337",D=[{path:"",component:(()=>{class i{constructor(e,o,n,s,d,u,x,y,S){this.navCtrl=e,this.activatedRoute=o,this.bleService=n,this.globalData=s,this.router=d,this.ble=u,this.alertCtrl=x,this.toastCtrl=y,this.ngZone=S,this.time=new Date(null),this.peripheral={},this.resultStringArray=[],this.i=0,this.actionflag=0,this.addressflag=!1,this.requestMTUflag=!1,this.deviceAddress=[];const _=this.router.getCurrentNavigation().extras.state.device;this.device=_,this.ble.connect(_.id).subscribe(()=>this.onConnected(),()=>this.onDeviceDisconnected())}ngOnDestroy(){this.routerSubscription&&this.routerSubscription.unsubscribe()}ngOnInit(){this.routerSubscription=this.router.events.pipe((0,f.h)(e=>e instanceof l.OD)).subscribe(e=>{"popstate"===e.navigationTrigger&&"/home"===e.url&&this.ble.disconnect(this.device.id).then(()=>console.log("Disconnected "),()=>console.log("ERROR disconnecting "))})}onConnected(){this.setStatus(""),this.ble.startNotification(this.device.id,p,"6e400003-b5a3-f393-e0a9-e50e24dc4179").subscribe(e=>this.onTemperatureChange(e),()=>this.presentreadAlert())}onTemperatureChange(e){switch(this.actionflag){case 1:const o=new Uint8Array(e[0]);console.log("data:"+o);for(let d=6;d>0;d--)this.deviceAddress.push(this.uint8ArrayToHexArray(o)[d]);this.ngZone.run(()=>{this.meterAddress=this.deviceAddress.join("").toString()}),this.updatedRootaddress=this.injectDeviceAddress("6800000000000068",this.deviceAddress.reverse()),this.globalData.setData("DeviceID",this.updatedRootaddress),console.log("updatedRootaddress:"+this.updatedRootaddress),this.calculateCS(),this.resultStringArray=[];break;case 2:console.log("Handling Command 2");const n=new Uint8Array(e[0]);this.resultStringArray=this.uint8ArrayToHexArray(n),console.log("resultStringArray:"+this.resultStringArray),this.ngZone.run(()=>{this.ywd=this.subtractHexValue(this.resultStringArray[this.resultStringArray.length-3],"33")+"-"+this.subtractHexValue(this.resultStringArray[this.resultStringArray.length-4],"33")+"-"+this.subtractHexValue(this.resultStringArray[this.resultStringArray.length-5],"33")}),console.log("ywd:"+this.ywd),this.resultStringArray=[];break;case 3:console.log("Handling Command 3");const s=new Uint8Array(e[0]);console.log("data3:"+s),this.resultStringArray=this.uint8ArrayToHexArray(s),console.log("resultStringArray:"+this.resultStringArray),this.resultStringArray=[];break;case 4:case 5:case 6:case 7:case 8:case 9:console.log("Handling Command 3");break;default:console.log("Unknown command")}}calculateCS(){this.cs4datedata=this.sumHexValuesAndKeep8Bits(this.updatedRootaddress+P).toUpperCase(),this.datedata=this.updatedRootaddress+P+this.cs4datedata+"16"}subtractHexValue(e,o){return(parseInt(e,16)-parseInt(o,16)).toString(16).toUpperCase()}onDeviceDisconnected(){return(0,g.mG)(this,void 0,void 0,function*(){(yield this.toastCtrl.create({message:"\u8bbe\u5907\u5df2\u65ad\u5f00",duration:5e3,position:"middle"})).present()})}writeCommand(e){switch(e){case"1":if(this.addressflag)return;console.log("Handling Command 1"),this.ble.requestMtu(this.device.id,247).then(()=>{console.log("MTU Size Accepted");const R=this.hexStringToUint8Array("68AAAAAAAAAAAA681300DF16");this.actionflag=1,this.ble.writeWithoutResponse(this.device.id,p,w,R.buffer),this.addressflag=!0},()=>{console.log("MTU Size Failed"),this.addressflag=!1});break;case"2":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 2"),this.router.navigate(["energy"],{state:{device:this.device}});break;case"3":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 3"),this.router.navigate(["load"],{state:{device:this.device}});break;case"4":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 4"),this.router.navigate(["power"],{state:{device:this.device}});break;case"5":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 5"),this.router.navigate(["value"],{state:{device:this.device}});break;case"6":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 6"),this.router.navigate(["current"],{state:{device:this.device}});break;case"7":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 7"),this.router.navigate(["quadrants"],{state:{device:this.device}});break;case"8":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 8"),this.router.navigate(["needs"],{state:{device:this.device}});break;case"9":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 9"),this.router.navigate(["feerate"],{state:{device:this.device}});break;case"10":if(!this.addressflag)return void this.readaddressAlert();console.log("Handling Command 10"),this.router.navigate(["event"],{state:{device:this.device}});break;default:console.log("Unknown command")}}uint8ArrayToHexArray(e){const o=[];for(let n=0;n<e.length;n++)o.push(e[n].toString(16).padStart(2,"0"));return o}hexStringToUint8Array(e){if(e.length%2!=0)throw new Error("Hexadecimal string must have an even length");const o=[];for(let n=0;n<e.length;n+=2){const s=e.substring(n,n+2),d=parseInt(s,16);if(isNaN(d))throw new Error(`Invalid hexadecimal number at position ${n}: ${s}`);o.push(d)}return new Uint8Array(o)}convertDecimalArrayToHexString(e){const o=this.reverseString(e.join(""));return parseInt(o,10).toString(16).toUpperCase()}stringToAsciiUint8Array(e){const o=new Uint8Array(e.length);for(let n=0;n<e.length;n++)o[n]=e.charCodeAt(n);return o}convertUint8ArrayToString(e){let o="";for(let n=0;n<e.length;n++)o+=String.fromCharCode(e[n]);return o}extractAndReverseBetween68s(e){const n=e.match(/68(.*?)68/);return n&&n[1]?this.reverseString(n[1]):null}getDeviceAddress(e){const n=e.match(/68(.*?)68/);return n&&n[1]?n[1]:null}reverseString(e){let o="";e.length%2!=0&&(o+=e.charAt(e.length-1));for(let n=0;n<e.length-1;n+=2)o=e.substring(n,n+2)+o;return o}convertStringToHexArray(e){if(e.length%2!=0)throw new Error("Input string must have an even number of characters");const o=[];for(let n=0;n<e.length;n+=2){const s=e.substring(n,n+2);if(!/^[0-9A-Fa-f]{2}$/.test(s))throw new Error("Input string contains invalid hexadecimal numbers");o.push(s.toUpperCase())}return o}sumHexValuesAndKeep8Bits(e){const o=e.match(/.{1,2}/g);if(!o)throw new Error("Invalid hex string");let n=0;return o.forEach(d=>{const u=parseInt(d,16);if(isNaN(u))throw new Error(`Invalid hex value encountered: ${d}`);n+=u}),(255&n).toString(16).padStart(2,"0")}injectDeviceAddress(e,o){let n=0;return e.replace(/00/g,()=>{var d;const u=null!==(d=o[n])&&void 0!==d?d:"00";return n++,u})}ionViewWillLeave(){this.ble.stopNotification(this.device.id,p,w)}ionViewWillEnter(){}readaddressAlert(){return(0,g.mG)(this,void 0,void 0,function*(){yield(yield this.alertCtrl.create({cssClass:"my-custom-class",header:"\u6e29\u99a8\u63d0\u793a",subHeader:"",message:"\u8bf7\u5148\u8bfb\u8868\u53f7",buttons:["OK"]})).present()})}presentreadAlert(){return(0,g.mG)(this,void 0,void 0,function*(){yield(yield this.alertCtrl.create({cssClass:"my-custom-class",header:"\u6e29\u99a8\u63d0\u793a",subHeader:"",message:"\u6570\u636e\u4f20\u8f93\u9519\u8bef",buttons:["OK"]})).present()})}setStatus(e){console.log(e),this.ngZone.run(()=>{this.statusMessage=e})}onDeviceReady(){console.log(navigator.notification)}alertDismissed(){console.log("it is OK")}dec(e,o){const n=Math.pow(10,o);return Math.round(e*n)/n}timeout(e){return new Promise(o=>setTimeout(o,e))}delay(){console.log("delay")}}return i.\u0275fac=function(e){return new(e||i)(t.Y36(a.SH),t.Y36(l.gz),t.Y36(k.x),t.Y36(c.v),t.Y36(l.F0),t.Y36(A.I),t.Y36(a.Br),t.Y36(a.yF),t.Y36(t.R0b))},i.\u0275cmp=t.Xpm({type:i,selectors:[["app-sensor"]],decls:58,vars:1,consts:[[1,"fixed-content"],[1,"coverhead"],[1,"tophead"],[1,"logo"],[1,"headtxt"],[1,"rectangle"],[1,"button-container"],[1,"energy-button",3,"click"],[1,"load-button",3,"click"],[1,"power-button",3,"click"],[1,"voltage-button",3,"click"],[1,"current-button",3,"click"],[1,"quad-button",3,"click"],[1,"need-button",3,"click"],[1,"cost-button",3,"click"],[1,"event-button",3,"click"],[1,"read-button",3,"click"],[1,"footer"],[1,"footer-content"],[1,"home-button"],[1,"report-button"],[1,"user-button"],["src","/assets/img/\u9996\u9875\u5b57.png",1,"home"],["src","/assets/img/\u62a5\u8868\u5b57.png",1,"report"],["src","/assets/img/\u7528\u6237\u5b57.png",1,"user"]],template:function(e,o){1&e&&(t.TgZ(0,"ion-content")(1,"div",0),t._UZ(2,"div",1)(3,"div",2)(4,"div",3),t.TgZ(5,"div",4),t._uU(6),t.qZA(),t.TgZ(7,"div",5)(8,"div",6)(9,"ion-button",7),t.NdJ("click",function(){return o.writeCommand("2")}),t.qZA(),t.TgZ(10,"span"),t._uU(11,"\u7528\u7535\u91cf"),t.qZA()(),t.TgZ(12,"div",6)(13,"ion-button",8),t.NdJ("click",function(){return o.writeCommand("3")}),t.qZA(),t.TgZ(14,"span"),t._uU(15,"\u8d1f\u8377\u66f2\u7ebf"),t.qZA()(),t.TgZ(16,"div",6)(17,"ion-button",9),t.NdJ("click",function(){return o.writeCommand("4")}),t.qZA(),t.TgZ(18,"span"),t._uU(19,"\u65e0\u529f\u66f2\u7ebf"),t.qZA()(),t.TgZ(20,"div",6)(21,"ion-button",10),t.NdJ("click",function(){return o.writeCommand("5")}),t.qZA(),t.TgZ(22,"span"),t._uU(23,"\u7535\u538b\u66f2\u7ebf"),t.qZA()(),t.TgZ(24,"div",6)(25,"ion-button",11),t.NdJ("click",function(){return o.writeCommand("6")}),t.qZA(),t.TgZ(26,"span"),t._uU(27,"\u7535\u6d41\u66f2\u7ebf"),t.qZA()(),t.TgZ(28,"div",6)(29,"ion-button",12),t.NdJ("click",function(){return o.writeCommand("7")}),t.qZA(),t.TgZ(30,"span"),t._uU(31,"\u56db\u8c61\u9650\u7535\u91cf"),t.qZA()(),t.TgZ(32,"div",6)(33,"ion-button",13),t.NdJ("click",function(){return o.writeCommand("8")}),t.qZA(),t.TgZ(34,"span"),t._uU(35,"\u9700\u91cf"),t.qZA()(),t.TgZ(36,"div",6)(37,"ion-button",14),t.NdJ("click",function(){return o.writeCommand("9")}),t.qZA(),t.TgZ(38,"span"),t._uU(39,"\u8d39\u7387\u65f6\u6bb5"),t.qZA()(),t.TgZ(40,"div",6)(41,"ion-button",15),t.NdJ("click",function(){return o.writeCommand("10")}),t.qZA(),t.TgZ(42,"span"),t._uU(43,"\u4e8b\u4ef6\u8bb0\u5f55"),t.qZA()(),t.TgZ(44,"div",6)(45,"ion-button",16),t.NdJ("click",function(){return o.writeCommand("1")}),t.qZA(),t.TgZ(46,"span"),t._uU(47,"\u8bfb\u8868\u53f7"),t.qZA()()(),t._UZ(48,"div",17),t.qZA()(),t.TgZ(49,"ion-footer")(50,"ion-toolbar")(51,"div",18),t._UZ(52,"ion-button",19)(53,"ion-button",20)(54,"ion-button",21)(55,"ion-img",22)(56,"ion-img",23)(57,"ion-img",24),t.qZA()()()),2&e&&(t.xp6(6),t.hij("\u8868\u53f7\uff1a",o.meterAddress,""))},dependencies:[a.YG,a.W2,a.fr,a.Xz,a.sr],styles:['@charset "UTF-8";.fixed-content[_ngcontent-%COMP%]{position:fixed;top:0;width:100%}ion-content[_ngcontent-%COMP%]{opacity:1;--overflow: hidden;--background: rgba(244, 248, 251, 1)}ion-button[_ngcontent-%COMP%]{--box-shadow: none;--outline-style: none;--padding-start: 0;--padding-end: 0;max-width:120px;max-height:60px;margin-bottom:4px}ion-button[_ngcontent-%COMP%]:hover, ion-button[_ngcontent-%COMP%]:active{opacity:.9}.headtxt[_ngcontent-%COMP%]{display:flex;position:absolute;z-index:3;top:30px;justify-content:center;width:100%;font-size:20px;font-weight:500;letter-spacing:0px;line-height:23.44px;color:#06211a}.tophead[_ngcontent-%COMP%]{left:0;top:0;width:100%;height:476px;position:absolute;z-index:2;opacity:.6;background:linear-gradient(166.95deg,rgb(148,191,255) 0%,rgb(227,230,250) 46.69%,rgb(244,248,251) 100%)}.coverhead[_ngcontent-%COMP%]{display:flex;position:relative;z-index:1;left:0;right:0;top:0;width:100%;height:467px;opacity:1;background:url(/assets/img/bg.png) no-repeat center center;background-size:cover}.logo[_ngcontent-%COMP%]{position:absolute;z-index:4;top:108px;left:50%;transform:translate(-50%);width:343px;height:161px;opacity:1;border-radius:8px;background:url(/assets/img/1.png) no-repeat center center;background-size:contain;background-clip:padding-box}.rectangle[_ngcontent-%COMP%]{background:rgb(255,255,255);display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(3,auto);gap:10px;justify-items:center;align-items:center;padding:10px;position:absolute;z-index:4;top:290px;left:50%;transform:translate(-50%);width:343px;height:289px;opacity:1;border-radius:10px}.button-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;text-align:center}.read-button[_ngcontent-%COMP%]{--background: url(/assets/img/event.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:contain;background-position:center;background-repeat:no-repeat;border:none}.event-button[_ngcontent-%COMP%]{--background: url(/assets/img/event.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:contain;background-position:center;background-repeat:no-repeat;border:none}.energy-button[_ngcontent-%COMP%]{--background: url(/assets/img/energy.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}.load-button[_ngcontent-%COMP%]{--background: url(/assets/img/loadcurve.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}.power-button[_ngcontent-%COMP%]{--background: url(/assets/img/pcurve.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}.voltage-button[_ngcontent-%COMP%]{--background: url(/assets/img/vcurve.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}.current-button[_ngcontent-%COMP%]{--background: url(/assets/img/current.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}.quad-button[_ngcontent-%COMP%]{--background: url(/assets/img/quadrant.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}.need-button[_ngcontent-%COMP%]{--background: url(/assets/img/need.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}.cost-button[_ngcontent-%COMP%]{--background: url(/assets/img/costrate.png) no-repeat center center / cover;width:44px;height:44px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:cover;background-position:center;border:none}span[_ngcontent-%COMP%]{display:block;font-size:12px}.footer-content[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(2,auto);gap:5px;justify-items:center;align-items:center;padding:10px;height:70px}.home-button[_ngcontent-%COMP%]{--background: url(/assets/img/\\9996\\9875.png) no-repeat center center / cover;width:28px;height:28px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:contain;background-position:center;background-repeat:no-repeat;border:none}.report-button[_ngcontent-%COMP%]{--background: url(/assets/img/\\62a5\\8868.png) no-repeat center center / cover;width:28px;height:28px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:contain;background-position:center;background-repeat:no-repeat;border:none}.user-button[_ngcontent-%COMP%]{--background: url(/assets/img/\\7528\\6237.png) no-repeat center center / cover;width:24px;height:24px;--padding-start: 0;--padding-end: 0;--padding-top: 0;--padding-bottom: 0;background-size:contain;background-position:center;background-repeat:no-repeat;border:none}']}),i})()}];let M=(()=>{class i{}return i.\u0275fac=function(e){return new(e||i)},i.\u0275mod=t.oAB({type:i}),i.\u0275inj=t.cJS({imports:[l.Bz.forChild(D),l.Bz]}),i})(),O=(()=>{class i{}return i.\u0275fac=function(e){return new(e||i)},i.\u0275mod=t.oAB({type:i}),i.\u0275inj=t.cJS({imports:[b.ez,v.u5,a.Pc,M]}),i})()},1414:(T,h,r)=>{r.d(h,{x:()=>f});var b=r(2096),v=r(7011);let f=(()=>{class t{constructor(c){this.ble=c}setNotificationCallback(c){this.onNotificationCallback=c}startNotification(c,A,p){this.ble.startNotification(c,A,p).subscribe(C=>{this.onNotificationCallback&&this.onNotificationCallback(C)},C=>console.error("Error starting notification:",C))}stopNotification(c,A,p){console.log("Stopping notification"),this.ble.stopNotification(c,A,p)}}return t.\u0275fac=function(c){return new(c||t)(b.LFG(v.I))},t.\u0275prov=b.Yz7({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()},4811:(T,h,r)=>{r.d(h,{v:()=>v});var b=r(2096);let v=(()=>{class a{constructor(){this.data={}}setData(g,f){this.data[g]=f}getData(g){return this.data[g]}}return a.\u0275fac=function(g){return new(g||a)},a.\u0275prov=b.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"}),a})()}}]);